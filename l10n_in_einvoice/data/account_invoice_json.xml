<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="l10n_in_invoice_request_payload_json">
{
    <t t-set="move" t-value="invoice.invoice_id"/>
    <t t-set="seller_details" t-value="move.journal_id.company_id.partner_id"/>
    <t t-set="buyer_details" t-value="move.partner_id"/>
    <t t-set="ship_details" t-value="move.partner_id"/>
    <t t-set="delivery_partner" t-value="'partner_shipping_id' in move and move.partner_shipping_id or move.partner_id"/>
    <t t-set="lines" t-value="move.invoice_line_ids.filtered(lambda l: not l.is_rounding_line)"/>
    <t t-set="taxes_amount" t-value="move.tax_amount_by_lines"/>
    <t t-set="amount_sign" t-value="move.type in ('out_invoice', 'in_refund') and 1 or -1"/>
    <t t-set="taxes_rate" t-value="move.tax_rate_by_lines"/>
    "Version": "1.1",
    "TranDtls": {
        "TaxSch": "GST",
        "SupTyp": "<t t-esc="invoice._get_supply_type(move)"/>",
        "RegRev": "<t t-esc="any(mv.tax_id.l10n_in_reverse_charge for mv in move.tax_line_ids) and 'Y' or 'N'"/>",
        "IgstOnIntra": "<t t-esc="'Y' if move.l10n_in_extend_state_id.id == move.company_id.partner_id.state_id.id and invoice.get_amount_by_group().get('IGST') else 'N'"/>"
    },
    "DocDtls": {
        "Typ": "<t t-esc="move.type == 'out_refund' and 'CRN' or move.type == 'in_refund' and 'DBN' or 'INV'"/>",
        "No": "<t t-esc="move.number"/>",
        "Dt": "<t t-esc="fields.Date.from_string(move.date_invoice).strftime('%d/%m/%Y')"/>"
    },
    "SellerDtls": {
        <t t-if="seller_details.vat">
            "Gstin": "<t t-esc="seller_details.vat"/>",
        </t>
        <t t-if="seller_details.name">
            "LglNm": "<t t-esc="seller_details.name"/>",
        </t>
        <t t-if="seller_details.name">
            "TrdNm": "<t t-esc="seller_details.name"/>",
        </t>
        <t t-if="seller_details.street">
            "Addr1": "<t t-esc="seller_details.street"/>",
        </t>
        <t t-if="seller_details.street2">
            "Addr2": "<t t-esc="seller_details.street2"/>",
        </t>
        <t t-if="seller_details.country_id.code == 'IN' and seller_details.city or False">
            "Loc": "<t t-esc="seller_details.country_id.code == 'IN' and seller_details.city or False"/>",
        </t>
        <t t-if="seller_details.zip">
            "Pin": <t t-esc="seller_details.zip"/>,
        </t>
        <t t-if="seller_details.state_id.l10n_in_tin">
            "Stcd": "<t t-esc="seller_details.state_id.l10n_in_tin"/>",
        </t>
        <t t-if="invoice._extract_digits(seller_details.mobile)">
            "Ph": "<t t-esc="invoice._extract_digits(seller_details.mobile)"/>",
        </t>
        <t t-if="seller_details.email">
            "Em": "<t t-esc="seller_details.email"/>"
        </t>
    },
    "BuyerDtls": {
        "Gstin": "<t t-esc="(move.l10n_in_import_export and move.l10n_in_export_type in ('regular','deemed','export_with_igst')) and 'URP' or buyer_details.vat"/>",
        <t t-if="buyer_details.name">
            "LglNm": "<t t-esc="buyer_details.name"/>",
        </t>
        <t t-if="buyer_details.name">
            "TrdNm": "<t t-esc="buyer_details.name"/>",
        </t>
        "Pos": "<t t-esc="move.l10n_in_extend_state_id.l10n_in_tin"/>",
        <t t-if="buyer_details.street">
            "Addr1": "<t t-esc="buyer_details.street"/>",
        </t>
        <t t-if="buyer_details.street2">
            "Addr2": "<t t-esc="buyer_details.street2"/>",
        </t>
        <t t-if="buyer_details.city">
            "Loc": "<t t-esc="buyer_details.city"/>",
        </t>
        <t t-if="buyer_details.zip">
            "Pin": <t t-esc="(move.l10n_in_import_export and move.l10n_in_export_type in ('regular','deemed','export_with_igst')) and '999999' or buyer_details.zip"/>,
        </t>
        <t t-if="buyer_details.state_id.l10n_in_tin or move.l10n_in_extend_state_id.l10n_in_tin">
            "Stcd": "<t t-esc="buyer_details.state_id.l10n_in_tin or move.l10n_in_extend_state_id.l10n_in_tin"/>",
        </t>
        <t t-if="invoice._extract_digits(buyer_details.mobile)">
            "Ph": "<t t-esc="invoice._extract_digits(buyer_details.mobile)"/>",
        </t>
        <t t-if="buyer_details.email">
            "Em": "<t t-esc="buyer_details.email"/>"
        </t>
    },
    "DispDtls": {
        <t t-set="dispatch_details" t-value="move.journal_id.company_id.partner_id"/>
        <t t-if="dispatch_details.name">
            "Nm": "<t t-esc="dispatch_details.name"/>",
        </t>
        <t t-if="dispatch_details.street">
            "Addr1": "<t t-esc="dispatch_details.street"/>",
        </t>
        <t t-if="dispatch_details.street2">
            "Addr2": "<t t-esc="dispatch_details.street2"/>",
        </t>
        <t t-if="dispatch_details.city">
            "Loc": "<t t-esc="dispatch_details.city"/>",
        </t>
        <t t-if="dispatch_details.zip">
            "Pin": <t t-esc="dispatch_details.zip"/>,
        </t>
        <t t-if="dispatch_details.state_id.l10n_in_tin">
            "Stcd": "<t t-esc="dispatch_details.state_id.l10n_in_tin"/>"
        </t>
    },
    "ShipDtls": {
            "Gstin": "<t t-esc="(move.l10n_in_import_export and move.l10n_in_export_type in ('regular','deemed','export_with_igst')) and 'URP' or ship_details.vat"/>",
        <t t-if="ship_details.commercial_company_name or ship_details.name">
            "LglNm": "<t t-esc="ship_details.commercial_company_name or ship_details.name"/>",
        </t>
        <t t-if="ship_details.commercial_company_name or ship_details.name">
            "TrdNm": "<t t-esc="ship_details.commercial_company_name or ship_details.name"/>",
        </t>
        <t t-if="ship_details.street">
            "Addr1": "<t t-esc="ship_details.street"/>",
        </t>
        <t t-if="ship_details.street2">
            "Addr2": "<t t-esc="ship_details.street2"/>",
        </t>
        <t t-if="ship_details.city">
            "Loc": "<t t-esc="ship_details.city"/>",
        </t>
        "Pin": <t t-esc="(move.l10n_in_import_export and move.l10n_in_export_type in ('regular','deemed','export_with_igst')) and '999999' or ship_details.zip"/>,
        <t t-if="ship_details.state_id.l10n_in_tin or move.l10n_in_extend_state_id.l10n_in_tin">
            "Stcd": "<t t-esc="ship_details.state_id.l10n_in_tin or move.l10n_in_extend_state_id.l10n_in_tin"/>"
        </t>
    },
    <t t-set="line_count" t-value="1"/>
    "ItemList": [

        <t t-foreach="lines" t-as="line">
        {
        "SlNo": "<t t-esc="line_count"/>",
        "PrdDesc": "<t t-esc="line.name.replace('\n', '')"/>",
        "IsServc": "<t t-esc="'Y' if line.product_id.type == 'service' else 'N'"/>",
        <t t-if="invoice._extract_digits(line.product_id.l10n_in_hsn_code)">
            "HsnCd": "<t t-esc="invoice._extract_digits(line.product_id.l10n_in_hsn_code)"/>",
        </t>
        <t t-if="line.product_id.barcode">
            "Barcde": "<t t-esc="line.product_id.barcode"/>",
        </t>
        "Qty": <t t-esc="round(line.quantity, 2) or 0.0"/>,
        "FreeQty": <t t-esc="round(line.quantity, 2) if round(line.price_unit, 2) == 0.00 else 0.0"/>,
        "Unit": "<t t-esc="line.uom_id.l10n_in_code and line.uom_id.l10n_in_code.split('-')[0] or 'OTH'"/>",
        "UnitPrice": <t t-esc="invoice.get_amount_in_INR(line.price_unit)"/>,
        "TotAmt": <t t-esc="invoice.get_amount_in_INR(line.price_subtotal)"/>,
        "Discount": <t t-esc="invoice.get_amount_in_INR(line.price_unit * line.quantity * (line.discount/100))"/>,
        "AssAmt": <t t-esc="invoice.get_amount_in_INR(line.price_subtotal * amount_sign)"/>,
        "GstRt": <t t-esc="invoice.get_gst_rate(taxes_rate, line.id)"/>,
        "IgstAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('IGST', 0.0))"/>,
        "CgstAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('CGST', 0.0))"/>,
        "SgstAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('SGST', 0.0))"/>,
        "CesRt": <t t-esc="taxes_rate.get(line.id, {}).get('CESS', 0.0)"/>,
        "CesAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('CESS', 0.0))"/>,
        "CesNonAdvlAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('CESS-NON-ADVOL', 0.0))"/>,
        "StateCesRt": <t t-esc="taxes_rate.get(line.id, {}).get('STATE CESS', 0.0)"/>,
        "StateCesAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('STATE CESS', 0.0))"/>,
        "StateCesNonAdvlAmt": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('STATE CESS-NON-ADVOL', 0.0))"/>,
        "OthChrg": <t t-esc="invoice.get_amount_in_INR(taxes_amount.get(str(line.id), {}).get('OTHER', 0.0))"/>,
        "TotItemVal": <t t-esc="invoice.get_amount_in_INR(line.price_total)"/>,
        },
        <t t-set="line_count" t-value="line_count + 1"/>
        </t>
    ],
    "ValDtls": {
        <t t-set="taxes_amount_values" t-value="taxes_amount.values()"/>
        "AssVal": <t t-esc="invoice.get_amount_in_INR(sum(lines.mapped('price_subtotal')))"/>,
        "CgstVal": <t t-esc="invoice.get_amount_in_INR(sum(tax_amount.get('CGST') or 0.00 for tax_amount in taxes_amount_values))"/>,
        "SgstVal": <t t-esc="invoice.get_amount_in_INR(sum(tax_amount.get('SGST') or 0.00 for tax_amount in taxes_amount_values))"/>,
        "IgstVal": <t t-esc="invoice.get_amount_in_INR(sum(tax_amount.get('IGST') or 0.00 for tax_amount in taxes_amount_values))"/>,
        "CesVal": <t t-esc="invoice.get_amount_in_INR(sum(tax_amount.get('CESS') or 0.00 for tax_amount in taxes_amount_values) + sum(tax_amount.get('CESS-NON-ADVOL') or 0.00 for tax_amount in taxes_amount_values))"/>,
        "Discount": 0,
        "OthChrg": 0,
        "StCesVal": <t t-esc="invoice.get_amount_in_INR(sum(tax_amount.get('STATE CESS') or 0.00 for tax_amount in taxes_amount_values) + sum(tax_amount.get('STATE CESS-NON-ADVOL') or 0.00 for tax_amount in taxes_amount_values))"/>,
        "RndOffAmt": <t t-esc="invoice.get_amount_in_INR(invoice.get_round_off_value(move) or 0.00)"/>,
        "TotInvVal": <t t-esc="invoice.get_amount_in_INR(move.amount_total)"/>,
        <t t-if="move.currency_id and move.company_id.currency_id != move.currency_id">
        "TotInvValFc": <t t-esc="move.amount_total"/>
        </t>
    },
    <t t-if="move.l10n_in_import_export">
    "ExpDtls": {
        <t t-if="move.l10n_in_shipping_bill_number">
            "ShipBNo": "<t t-esc="move.l10n_in_shipping_bill_number"/>",
        </t>
        <t t-if="move.l10n_in_shipping_bill_date">
            "ShipBDt": "<t t-esc="fields.Date.from_string(move.l10n_in_shipping_bill_date).strftime('%Y-%m-%d')"/>",
        </t>
        <t t-if="move.l10n_in_shipping_port_code">
            "Port": "<t t-esc="move.l10n_in_shipping_port_code"/>",
        </t>
            "RefClm": "<t t-esc="invoice.get_amount_by_group().get('IGST') and 'Y' or 'N'"/>",
        <t t-if="move.currency_id">
            "ForCur": "<t t-esc="move.currency_id.name"/>",
        </t>
        <t t-if="move.commercial_partner_id.country_id">
            "CntCode": "<t t-esc="move.commercial_partner_id.country_id.code"/>",
        </t>
    },
    </t>
}
    </template>
</odoo>
